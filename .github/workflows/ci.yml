name: Run Tests with Allure Report

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Java 22
        run: |
          sudo apt update
          sudo apt install -y openjdk-22-jdk
          echo "JAVA_HOME=/usr/lib/jvm/java-22-openjdk-amd64" >> $GITHUB_ENV
          echo "/usr/lib/jvm/java-22-openjdk-amd64/bin" >> $GITHUB_PATH

      - name: Verify Java version
        run: java -version

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Run tests with Maven
        run: mvn clean test -Dallure.results.directory=allure-results

      - name: Generate Allure Report
        run: mvn allure:report

      - name: Upload Allure Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/site/allure-maven/
          retention-days: 7  # Зберігати артефакт 7 днів